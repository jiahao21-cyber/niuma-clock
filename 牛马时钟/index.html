<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ç‰›é©¬æ—¶é’Ÿ Pro Max</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0d0d;
            --primary: #00ff41;
            --gold: #ffd700;
            --danger: #ff0055;
            --card-bg: #1a1a1a;
            --text-dim: #666;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--primary);
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        /* --- ä¸»ç•Œé¢å¸ƒå±€ --- */
        .dashboard {
            flex: 1;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .sys-status {
            position: absolute; top: 15px; left: 15px;
            font-size: 0.7rem; color: var(--danger);
            border: 1px solid var(--danger); padding: 2px 6px;
            border-radius: 4px; letter-spacing: 1px;
            animation: blink 2s infinite;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

        .money-display {
            text-align: center;
            margin-bottom: 10px;
            position: relative;
        }
        
        .currency { font-size: 1.5rem; color: var(--gold); vertical-align: top; }
        #money { 
            font-size: 3.8rem; 
            font-weight: 800; 
            text-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
            font-variant-numeric: tabular-nums; 
        }

        /* æ¯’é¸¡æ±¤åŒºåŸŸ (æ–°å¢) */
        .quote-box {
            height: 50px;
            display: flex; align-items: center; justify-content: center;
            text-align: center;
            font-size: 0.85rem;
            color: #888;
            font-style: italic;
            margin-bottom: 20px;
            padding: 0 20px;
            opacity: 0.8;
            transition: opacity 0.5s;
        }

        /* è´­ä¹°åŠ›æ¡ */
        .power-bar {
            background: rgba(255,255,255,0.05);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #ccc;
            margin-bottom: 25px;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 200px;
            justify-content: center;
        }

        /* è¿›åº¦æ¡ */
        .progress-track {
            width: 100%; max-width: 320px; height: 6px; 
            background: #222; border-radius: 3px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: var(--primary); width: 0%;
            box-shadow: 0 0 10px var(--primary);
            transition: width 0.2s;
        }

        /* --- å¸¦è–ªæ‹‰å±åŒº --- */
        .poop-card {
            margin-top: 30px;
            width: 100%; max-width: 350px;
            border: 1px dashed #444;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            background: rgba(0,0,0,0.3);
        }
        .btn-poop {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        .btn-poop.active {
            background: var(--primary); color: black;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0,255,65,0.4); } 70% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } }

        .poop-stats {
            display: none; margin-top: 10px; font-size: 0.9rem; color: var(--gold);
        }
        .poop-stats.show { display: block; }

        /* --- åº•éƒ¨å¯¼èˆª --- */
        .navbar {
            width: 100%;
            padding: 15px;
            background: #111;
            border-top: 1px solid #222;
            display: flex;
            justify-content: space-around;
        }
        .nav-item {
            color: #666;
            font-size: 1.5rem;
            background: none; border: none;
            cursor: pointer;
            position: relative;
        }
        .nav-item:active { transform: scale(0.9); }
        .badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--danger); color: white;
            font-size: 0.7rem; width: 16px; height: 16px;
            border-radius: 50%; display: none;
            align-items: center; justify-content: center;
        }

        /* --- å¼¹çª—é€šç”¨ --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex; justify-content: center; align-items: flex-end;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal.open { opacity: 1; pointer-events: all; }
        .modal-content {
            background: #161616;
            width: 100%; max-width: 500px;
            height: 80vh; /* å æ®80%é«˜åº¦ */
            border-radius: 20px 20px 0 0;
            border-top: 1px solid var(--primary);
            padding: 20px;
            overflow-y: auto;
            transform: translateY(100%); transition: 0.3s;
        }
        .modal.open .modal-content { transform: translateY(0); }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;
        }

        /* --- æˆå°±åˆ—è¡¨æ ·å¼ --- */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }
        .trophy {
            background: #222;
            border-radius: 10px;
            padding: 15px 5px;
            text-align: center;
            opacity: 0.5;
            filter: grayscale(1);
            transition: 0.3s;
            border: 1px solid transparent;
        }
        .trophy.unlocked {
            opacity: 1;
            filter: grayscale(0);
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.1);
        }
        .trophy-icon { font-size: 2rem; margin-bottom: 5px; display: block; }
        .trophy-title { font-size: 0.7rem; font-weight: bold; color: #fff; display: block; }
        .trophy-desc { font-size: 0.6rem; color: #888; margin-top: 5px; display: none; }

        /* ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹åœ¨è¿™é‡Œï¼šåªè¦æœ‰ .unlocked ç±»ï¼ˆå·²è§£é”ï¼‰ï¼Œå°±ç›´æ¥æ˜¾ç¤º */
        .trophy.unlocked .trophy-desc { display: block; color: var(--gold); }

        /* ğŸ‘‡ è¿™ä¸€è¡Œä¿ç•™ï¼Œè¿™æ ·æœªè§£é”çš„æˆå°±ï¼Œä½ æŒ‰ä½è¿˜æ˜¯èƒ½çœ‹åˆ° "???" */
        .trophy:active .trophy-desc { display: block; }

        /* --- è®¾ç½®è¾“å…¥æ¡† --- */
        .input-row { margin-bottom: 15px; }
        .input-row label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 5px; }
        .input-row input {
            width: 100%; background: #000; border: 1px solid #333;
            color: var(--primary); padding: 10px; font-family: inherit;
        }

        /* --- æç¤ºæ¡ (Toast) --- */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: var(--gold); color: black;
            padding: 10px 20px; border-radius: 30px;
            font-weight: bold; font-size: 0.9rem;
            box-shadow: 0 5px 20px rgba(255,215,0,0.4);
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200; pointer-events: none;
            display: flex; align-items: center; gap: 10px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* éŸ³é‡å¼€å…³ */
        .sound-toggle {
            position: absolute; top: 15px; right: 15px;
            color: #444; cursor: pointer; font-size: 1.2rem;
            z-index: 10;
        }
        .sound-toggle.on { color: var(--primary); }

    </style>
</head>
<body>

    <!-- å£°éŸ³æ–‡ä»¶: ç¡¬å¸å£° -->
    <audio id="sfx-coin" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
    <audio id="sfx-unlock" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3" preload="auto"></audio>

    <!-- é¡¶éƒ¨ -->
    <div class="sys-status" id="sys-msg">SYSTEM: DEGRADING</div>
    <div class="sound-toggle" id="btn-sound" onclick="toggleSound()">
        <i class="fas fa-volume-mute"></i>
    </div>

    <!-- æç¤ºæ¡ -->
    <div class="toast" id="toast">
        <i class="fas fa-trophy"></i>
        <span id="toast-msg">è§£é”æˆå°±</span>
    </div>

    <div class="dashboard">
        <div style="font-size:0.8rem; color:#444; margin-bottom:5px;">ä»Šæ—¥å·²å‡ºå–çµé­‚å€¼</div>
        
        <div class="money-display">
            <span class="currency">Â¥</span><span id="money">0.0000</span>
        </div>

        <!-- æ¯’é¸¡æ±¤åŒº -->
        <div class="quote-box" id="quote-display">
            åŠ è½½ä»Šæ—¥ä»½çš„ç»æœ›...
        </div>

        <div class="power-bar" id="power-msg">
            <i class="fas fa-hourglass-start"></i> ç³»ç»Ÿåˆå§‹åŒ–...
        </div>

        <div class="progress-track">
            <div class="progress-fill" id="progress-bar"></div>
        </div>

        <!-- æ‹‰å±å¡ç‰‡ -->
        <div class="poop-card">
            <button class="btn-poop" id="btn-poop" onclick="togglePoop()">
                <i class="fas fa-toilet"></i> <span>å¼€å§‹å¸¦è–ªæ‹‰å±</span>
            </button>
            <div class="poop-stats" id="poop-stats">
                <div style="font-size: 1.2rem; margin: 5px 0;">+Â¥<span id="poop-money">0.00</span></div>
                <div style="font-size: 0.7rem; color: #666;">è€—æ—¶: <span id="poop-time">00:00</span></div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="navbar">
        <button class="nav-item" onclick="openModal('modal-settings')"><i class="fas fa-cog"></i></button>
        <button class="nav-item" onclick="openModal('modal-achievements')">
            <i class="fas fa-medal"></i>
            <div class="badge" id="badge-new">!</div>
        </button>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div class="modal" id="modal-settings">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è–ªèµ„é…ç½®</h3>
                <i class="fas fa-times" onclick="closeModals()" style="cursor:pointer"></i>
            </div>
            <div class="input-row">
                <label>æœˆè–ª (ç¨å/åˆ°æ‰‹)</label>
                <input type="number" id="inp-salary" placeholder="10000">
            </div>
            <div class="input-row">
                <label>æœˆå·¥ä½œå¤©æ•°</label>
                <input type="number" id="inp-days" value="21.75">
            </div>
            <div class="input-row">
                <label>ä¸Šç­æ—¶é—´ (0-24)</label>
                <input type="number" id="inp-start" value="9">
            </div>
            <div class="input-row">
                <label>ä¸‹ç­æ—¶é—´ (0-24)</label>
                <input type="number" id="inp-end" value="18">
            </div>
            <button onclick="saveConfig()" style="width:100%; padding:15px; background:var(--primary); border:none; border-radius:5px; font-weight:bold; margin-top:10px;">ä¿å­˜</button>
        </div>
    </div>

    <!-- æˆå°±å¼¹çª— -->
    <div class="modal" id="modal-achievements">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ‘¸é±¼æˆå°±é¦† (<span id="ach-count">0</span>/8)</h3>
                <i class="fas fa-times" onclick="closeModals()" style="cursor:pointer"></i>
            </div>
            <div style="font-size:0.7rem; color:#666; margin-bottom:15px; text-align:center;">
                ç‚¹å‡»å›¾æ ‡æŸ¥çœ‹è§£é”æ¡ä»¶
            </div>
            <div class="achievement-grid" id="ach-grid">
                <!-- JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

<script>
    // --- 1. é…ç½®ä¸çŠ¶æ€ ---
    let config = { salary: 10000, days: 21.75, start: 9, end: 18 };
    let state = {
        earned: 0,
        pooping: false,
        poopStart: 0,
        soundOn: false,
        lastHundred: 0 
    };

    // æ¯’é¸¡æ±¤åº“
    const quotes = [
        "â˜• å’–å•¡æ˜¯ç‰›é©¬çš„æœºæ²¹",
        "ğŸ¢ åªè¦æˆ‘å¹²å¾—å¤Ÿæ…¢ï¼Œå·¥ä½œå°±è¿½ä¸ä¸Šæˆ‘",
        "ğŸ›‘ æ­¤æ—¶æ­¤åˆ»ï¼Œä½ çš„è€æ¿æ­£åœ¨æ‰“é«˜å°”å¤«",
        "ğŸ“‰ åŠªåŠ›å·¥ä½œï¼Œå¥½è®©è€æ¿æ¢ä¸ªæ–°è½¦",
        "ğŸ”‹ ç”µé‡ä¸è¶³ï¼Œå»ºè®®å‘è–ªé‡å¯",
        "ğŸ§˜â€â™‚ï¸ åªè¦æˆ‘å¤ŸåºŸç‰©ï¼Œå°±æ²¡äººèƒ½åˆ©ç”¨æˆ‘",
        "ğŸŸ æ‘¸é±¼æ˜¯å·¥ä½œçš„ä¸€éƒ¨åˆ†ï¼Œä¸æ‘¸äºæ­»",
        "ğŸ¤¡ å·¥èµ„æ˜¯ç²¾ç¥æŸå¤±è´¹ï¼Œä¸å«è¯¯å·¥è´¹",
        "ğŸ›Œ æ¢¦æƒ³æ˜¯ä¸ç”¨ä¸Šç­ï¼Œç°å®æ˜¯å¤©å¤©æ¬ç –",
        "ğŸ’€ å‚æ­»ç—…ä¸­æƒŠåèµ·ï¼Œè¿˜æ˜¯è¦å»æ‰“å¡æœº"
    ];

    // æˆå°±å®šä¹‰ (æ›´æ‰å¿ƒçš„æ–‡æ¡ˆ)
    const achievements = [
        { id: 'start', icon: 'ğŸ‘¶', title: 'å…¥ç‹±ç™»è®°', desc: 'ç¬¬ä¸€æ¬¡å¯åŠ¨æœ¬ç³»ç»Ÿï¼Œæ¬¢è¿æ¥åˆ°åœ°ç‹±' },
        { id: 'rich_100', icon: 'ğŸŸ', title: 'æ¸©é¥±çº¿', desc: 'èµšå¤Ÿ100å—ï¼Œå¤Ÿä¹°é¡¿ç–¯ç‹‚æ˜ŸæœŸå››äº†' },
        { id: 'rich_500', icon: 'ğŸ¦', title: 'å°åº·å¹»è§‰', desc: 'æ—¥è–ª500ï¼Œç¨å¾®æœ‰ç‚¹äººæ ·äº†' },
        { id: 'rich_1000', icon: 'ğŸ’', title: 'èµ„æœ¬èµ°ç‹—', desc: 'æ—¥è–ª1000ï¼Ÿè€æ¿äº²æˆšå§ä½ ' },
        { id: 'morning', icon: 'ğŸ¦', title: 'è‡ªæ„¿ä¸ºå¥´', desc: '8:50å‰å°±æ‰“å¼€ç³»ç»Ÿï¼ŒçœŸæ˜¯è€æ¿çš„å¥½å¤§å„¿' },
        { id: 'overtime', icon: 'ğŸŒ™', title: 'ç”¨çˆ±å‘ç”µ', desc: '19:30è¿˜åœ¨çœ‹ï¼Ÿè€æ¿ä¼šæ„ŸåŠ¨åœ°æ‰£ä½ ç»©æ•ˆ' },
        { id: 'poop_king', icon: 'ğŸš½', title: 'å•æ‰€ä¹‹ç‹', desc: 'è¹²å‘è¶…è¿‡15åˆ†é’Ÿï¼Œè…¿éº»äº†å—ï¼Ÿ' },
        { id: 'poop_quick', icon: 'âš¡', title: 'äºæœ¬ä¹°å–', desc: 'æ‹‰å±ä¸è¶³2åˆ†é’Ÿï¼Œä½ æ˜¯åœ¨å¸®å…¬å¸çœæ°´å—ï¼Ÿ' }
    ];
    let unlocked = [];

    // ç‰©å“å¯¹ç…§
    const items = [
        {p: 2, n: 'å¤è›‹', i: 'ğŸ¥š'}, {p: 15, n: 'å¥¶èŒ¶', i: 'ğŸ§‹'}, 
        {p: 35, n: 'å’–å•¡', i: 'â˜•'}, {p: 80, n: 'ç«é”…', i: 'ğŸ²'},
        {p: 300, n: 'å£çº¢', i: 'ğŸ’„'}, {p: 2000, n: 'æ¸¸æˆæœº', i: 'ğŸ®'}
    ];

    // --- 2. åˆå§‹åŒ– ---
    function init() {
        const localCfg = localStorage.getItem('nm_cfg_v4');
        if (localCfg) config = JSON.parse(localCfg);
        
        const localAch = localStorage.getItem('nm_ach_v4');
        if (localAch) unlocked = JSON.parse(localAch);
        
        document.getElementById('inp-salary').value = config.salary;
        document.getElementById('inp-days').value = config.days;
        document.getElementById('inp-start').value = config.start;
        document.getElementById('inp-end').value = config.end;

        renderAchievements();
        checkAchievements('start'); 
        updateRandomQuote();

        setInterval(tick, 100);
        setInterval(checkTimeAchievements, 60000); 
        setInterval(updateRandomQuote, 8000); // 8ç§’æ¢ä¸€å¥æ¯’é¸¡æ±¤
    }

    // --- 3. æ ¸å¿ƒé€»è¾‘ ---
    function tick() {
        const now = new Date();
        const startH = config.start;
        const endH = config.end;
        
        const workSecs = (endH - startH) * 3600;
        if (workSecs <= 0) return;
        const perSec = config.salary / config.days / workSecs;

        const startTs = new Date(now).setHours(startH, 0, 0, 0);
        const endTs = new Date(now).setHours(endH, 0, 0, 0);
        const curTs = now.getTime();
        const curH = now.getHours();

        let money = 0;
        let pct = 0;

        // æ›´æ–°å·¦ä¸Šè§’çŠ¶æ€æ 
        updateSysStatus(curH, startH, endH);

        if (curTs < startTs) {
            money = 0;
            document.getElementById('power-msg').innerHTML = "ğŸ’¤ å°šæœªå¼€æœº";
        } else if (curTs > endTs) {
            money = config.salary / config.days;
            pct = 100;
            document.getElementById('power-msg').innerHTML = "ğŸ‰ è¶Šç‹±æˆåŠŸ (å·²ä¸‹ç­)";
            document.getElementById('power-msg').style.color = 'var(--gold)';
        } else {
            const worked = (curTs - startTs) / 1000;
            money = worked * perSec;
            pct = (worked / workSecs) * 100;
            updatePowerMsg(money);
            
            const hundreds = Math.floor(money / 100);
            if (hundreds > state.lastHundred && hundreds > 0) {
                playMoneySound();
                state.lastHundred = hundreds;
            }
        }

        state.earned = money;
        document.getElementById('money').innerText = money.toFixed(4);
        document.getElementById('progress-bar').style.width = pct + '%';

        if (money >= 100) checkAchievements('rich_100');
        if (money >= 500) checkAchievements('rich_500');
        if (money >= 1000) checkAchievements('rich_1000');

        if (state.pooping) {
            const pTime = (Date.now() - state.poopStart) / 1000;
            const pMoney = pTime * perSec;
            document.getElementById('poop-money').innerText = pMoney.toFixed(2);
            const m = Math.floor(pTime / 60).toString().padStart(2,'0');
            const s = Math.floor(pTime % 60).toString().padStart(2,'0');
            document.getElementById('poop-time').innerText = `${m}:${s}`;
        }
    }

    // å·¦ä¸Šè§’çŠ¶æ€æ åæ§½é€»è¾‘
    function updateSysStatus(h, start, end) {
        const el = document.getElementById('sys-msg');
        if (h < start) {
            el.innerText = "STATUS: SLEEPING";
            el.style.borderColor = '#666'; el.style.color = '#666';
        } else if (h >= end) {
            el.innerText = "STATUS: FREEDOM";
            el.style.borderColor = 'var(--gold)'; el.style.color = 'var(--gold)';
        } else {
            // å·¥ä½œä¸­
            if (h === 12 || h === 13) {
                el.innerText = "STATUS: REFUELING (LUNCH)"; // åˆä¼‘
            } else if (h >= 14 && h <= 16) {
                el.innerText = "STATUS: COMA (FOOD COMA)"; // é¥­åæ™•
            } else if (h === end - 1) {
                el.innerText = "STATUS: READY TO ESCAPE"; // å¿«ä¸‹ç­
            } else {
                el.innerText = "STATUS: SUFFERING"; // å—éš¾ä¸­
            }
            el.style.borderColor = 'var(--danger)'; el.style.color = 'var(--danger)';
        }
    }

    function updateRandomQuote() {
        const idx = Math.floor(Math.random() * quotes.length);
        const box = document.getElementById('quote-display');
        box.style.opacity = 0;
        setTimeout(() => {
            box.innerText = quotes[idx];
            box.style.opacity = 0.8;
        }, 500);
    }

    function updatePowerMsg(money) {
        let target = null;
        for (let i = items.length - 1; i >= 0; i--) {
            if (money >= items[i].p) { target = items[i]; break; }
        }
        if (target) {
            const num = (money / target.p).toFixed(1);
            document.getElementById('power-msg').innerHTML = `${target.i} å·²å›è¡€ <b>${num}</b> ä¸ª${target.n}`;
            document.getElementById('power-msg').style.color = 'var(--gold)';
        } else {
            const diff = (items[0].p - money).toFixed(2);
            // ç©·é¬¼æ–‡æ¡ˆ
            document.getElementById('power-msg').innerHTML = `ğŸ¥š è¿ä¸ª${items[0].n}éƒ½ä¹°ä¸èµ· (å·®Â¥${diff})`;
            document.getElementById('power-msg').style.color = '#888';
        }
    }

    // --- 4. å£°éŸ³ä¸äº¤äº’ ---
    function toggleSound() {
        state.soundOn = !state.soundOn;
        const btn = document.getElementById('btn-sound');
        if (state.soundOn) {
            btn.innerHTML = '<i class="fas fa-volume-up"></i>';
            btn.classList.add('on');
            playMoneySound();
        } else {
            btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            btn.classList.remove('on');
        }
    }

    function playMoneySound() {
        if (!state.soundOn) return;
        const audio = document.getElementById('sfx-coin');
        audio.currentTime = 0;
        audio.play().catch(e=>{});
    }
    
    function playUnlockSound() {
        if (!state.soundOn) return;
        const audio = document.getElementById('sfx-unlock');
        audio.currentTime = 0;
        audio.play().catch(e=>{});
    }

    function togglePoop() {
        const btn = document.getElementById('btn-poop');
        const stats = document.getElementById('poop-stats');
        
        if (!state.pooping) {
            state.pooping = true;
            state.poopStart = Date.now();
            btn.innerHTML = '<i class="fas fa-stop"></i> ç»“æŸ (å¿«æ“¦å±è‚¡)';
            btn.classList.add('active');
            stats.classList.add('show');
        } else {
            const durationMins = (Date.now() - state.poopStart) / 1000 / 60;
            state.pooping = false;
            btn.innerHTML = '<i class="fas fa-toilet"></i> å†æ¥ä¸€è¹²';
            btn.classList.remove('active');
            
            if (durationMins >= 15) checkAchievements('poop_king');
            if (durationMins < 2) checkAchievements('poop_quick');
        }
    }

    // --- 5. æˆå°±ä¸å¼¹çª— ---
    function checkAchievements(id) {
        if (unlocked.includes(id)) return;
        unlocked.push(id);
        localStorage.setItem('nm_ach_v4', JSON.stringify(unlocked));
        
        const ach = achievements.find(a => a.id === id);
        showToast(ach.title);
        playUnlockSound();
        renderAchievements();
        document.getElementById('badge-new').style.display = 'flex';
    }

    function checkTimeAchievements() {
        const h = new Date().getHours();
        const m = new Date().getMinutes();
        const nowVal = h * 60 + m;
        if (nowVal < 530) checkAchievements('morning'); 
        if (nowVal > 1170) checkAchievements('overtime');
    }

    function renderAchievements() {
        const grid = document.getElementById('ach-grid');
        grid.innerHTML = '';
        let count = 0;
        achievements.forEach(ach => {
            const isUnlocked = unlocked.includes(ach.id);
            if (isUnlocked) count++;
            const div = document.createElement('div');
            div.className = `trophy ${isUnlocked ? 'unlocked' : ''}`;
            div.innerHTML = `
                <span class="trophy-icon">${isUnlocked ? ach.icon : 'ğŸ”’'}</span>
                <span class="trophy-title">${ach.title}</span>
                <div class="trophy-desc">${isUnlocked ? ach.desc : '???'}</div>
            `;
            grid.appendChild(div);
        });
        document.getElementById('ach-count').innerText = count;
    }

    function showToast(title) {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = `è§£é”æˆå°±ï¼š${title}`;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function openModal(id) {
        document.getElementById(id).classList.add('open');
        if (id === 'modal-achievements') {
            document.getElementById('badge-new').style.display = 'none';
        }
    }
    function closeModals() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('open'));
    }
    function saveConfig() {
        config.salary = parseFloat(document.getElementById('inp-salary').value);
        config.days = parseFloat(document.getElementById('inp-days').value);
        config.start = parseFloat(document.getElementById('inp-start').value);
        config.end = parseFloat(document.getElementById('inp-end').value);
        localStorage.setItem('nm_cfg_v4', JSON.stringify(config));
        closeModals();
    }

    init();
</script>
</body>
</html>